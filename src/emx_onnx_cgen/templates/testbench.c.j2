{% if rng_requires_u64 %}
static uint64_t rng_state = 0x243f6a8885a308d3ull;

static uint64_t rng_next_u64(void) {
    uint64_t x = rng_state;
    x ^= x >> 12;
    x ^= x << 25;
    x ^= x >> 27;
    rng_state = x;
    return x * 0x2545f4914f6cdd1dull;
}
{% endif %}

{% if rng_requires_float %}
static float rng_next_float(void) {
    return (float)((double)rng_next_u64() * (1.0 / 18446744073709551616.0));
}
{% endif %}

{% if rng_requires_double %}
static double rng_next_double(void) {
    return (double)rng_next_u64() * (1.0 / 18446744073709551616.0);
}
{% endif %}

{% if rng_requires_i64 %}
static int64_t rng_next_i64(void) {
    return (int64_t)rng_next_u64();
}
{% endif %}

{% for input in inputs %}
{% if input.constant_lines %}
static const {{ input.c_type }} {{ input.constant_name }}[] = {
{% for line in input.constant_lines %}
    {{ line }}{% if not loop.last %},{% endif %}
{% endfor %}
};
{% endif %}
{% endfor %}

__attribute__((weak, noinline)) void timer_start(void) {}
__attribute__((weak, noinline)) void timer_stop(void) {}

{% set constant_inputs = inputs | selectattr('constant_name') | list %}
{% set variable_inputs = inputs | rejectattr('constant_name') | list %}

static void testbench_init_constant_input({% if not constant_inputs %}void{% else %}{% for input in constant_inputs %}{{ input.c_type }} {{ input.name }}{{ input.array_suffix }}{% if not loop.last %}, {% endif %}{% endfor %}{% endif %}) {
{% if not constant_inputs %}
    (void)0;
{% endif %}
{% for input in inputs %}
{% if input.constant_name %}
{% if input.rank == 0 %}
    {{ input.name }} = {{ input.constant_name }}[0];
{% else %}
{% for depth in range(input.rank) %}
    for (idx_t {{ input.loop_vars[depth] }} = 0; {{ input.loop_vars[depth] }} < {{ input.shape[depth] }}; ++{{ input.loop_vars[depth] }}) {
{% endfor %}
        {{ input.name }}{{ input.array_index_expr }} = {{ input.constant_name }}[{{ input.index_expr }}];
{% for depth in range(input.rank - 1, -1, -1) %}
    }
{% endfor %}
{% endif %}
{% endif %}
{% endfor %}
}

static int testbench_read_input_file(
    const char *input_path{% for input in variable_inputs %}, {{ input.c_type }} {{ input.name }}{{ input.array_suffix }}{% endfor %}
) {
{% if not variable_inputs %}
    (void)input_path;
    return 0;
{% else %}
    FILE *input_file = fopen(input_path, "rb");
    if (!input_file) {
        fprintf(stderr, "Failed to open input file: %s\n", input_path);
        return 1;
    }
{% for input in inputs %}
{% if not input.constant_name %}
{% for depth in range(input.rank) %}
    for (idx_t {{ input.loop_vars[depth] }} = 0; {{ input.loop_vars[depth] }} < {{ input.shape[depth] }}; ++{{ input.loop_vars[depth] }}) {
{% endfor %}
        if (fread(&{{ input.name }}{{ input.array_index_expr }}, sizeof({{ input.c_type }}), 1, input_file) != 1) {
            fprintf(stderr, "Failed to read input {{ input.json_name }}\n");
            fclose(input_file);
            return 1;
        }
{% for depth in range(input.rank - 1, -1, -1) %}
    }
{% endfor %}
{% endif %}
{% endfor %}

    fclose(input_file);
    return 0;
{% endif %}
}

static void testbench_fill_random_input({% if not variable_inputs %}void{% else %}{% for input in variable_inputs %}{{ input.c_type }} {{ input.name }}{{ input.array_suffix }}{% if not loop.last %}, {% endif %}{% endfor %}{% endif %}) {
{% if not variable_inputs %}
    (void)0;
{% endif %}
{% for input in inputs %}
{% if not input.constant_name %}
{% for depth in range(input.rank) %}
    for (idx_t {{ input.loop_vars[depth] }} = 0; {{ input.loop_vars[depth] }} < {{ input.shape[depth] }}; ++{{ input.loop_vars[depth] }}) {
{% endfor %}
        {{ input.name }}{{ input.array_index_expr }} = {{ input.random_expr }};
{% for depth in range(input.rank - 1, -1, -1) %}
    }
{% endfor %}
{% endif %}
{% endfor %}
}

static void testbench_print_json(
{% for input in inputs %}
    {{ input.c_type }} {{ input.name }}{{ input.array_suffix }},
{% endfor %}
{% for output in outputs %}
    {{ output.c_type }} {{ output.name }}{{ output.array_suffix }}{% if not loop.last %},
{% endif %}
{% endfor %}
) {
    printf("{\"inputs\":{");
{% for input in inputs %}
{% if not loop.first %}
    printf(",");
{% endif %}
    printf("\"{{ input.json_name }}\":{\"shape\":[{{ input.shape_literal }}],\"data\":");
    printf("[");
{% for depth in range(input.rank) %}
for (idx_t {{ input.loop_vars[depth] }} = 0; {{ input.loop_vars[depth] }} < {{ input.shape[depth] }}; ++{{ input.loop_vars[depth] }}) {
    if ({{ input.loop_vars[depth] }}) {
        printf(",");
    }
{% if depth < input.rank - 1 %}
    printf("[");
{% endif %}
{% endfor %}
printf("{{ input.print_format }}", {{ input.print_cast }}{{ input.name }}{{ input.array_index_expr }});
{% for depth in range(input.rank - 1, -1, -1) %}
{% if depth < input.rank - 1 %}
    printf("]");
{% endif %}
}
{% endfor %}
    printf("]}");
{% endfor %}

    printf("},\"outputs\":{");
{% for output in outputs %}
{% if not loop.first %}
    printf(",");
{% endif %}
    printf("\"{{ output.json_name }}\":{\"shape\":[{{ output.shape_literal }}],\"data\":");
    printf("[");
{% for depth in range(output.rank) %}
for (idx_t {{ output.loop_vars[depth] }} = 0; {{ output.loop_vars[depth] }} < {{ output.shape[depth] }}; ++{{ output.loop_vars[depth] }}) {
    if ({{ output.loop_vars[depth] }}) {
        printf(",");
    }
{% if depth < output.rank - 1 %}
    printf("[");
{% endif %}
{% endfor %}
printf("{{ output.print_format }}", {{ output.print_cast }}{{ output.name }}{{ output.array_index_expr }});
{% for depth in range(output.rank - 1, -1, -1) %}
{% if depth < output.rank - 1 %}
    printf("]");
{% endif %}
}
{% endfor %}
    printf("]}");
{% endfor %}
    printf("}}\n");
}

static int testbench_run(const char *input_path) {
{% for dim in dim_args %}
    int {{ dim.name }} = {{ dim.value }};
{% endfor %}

{% for input in inputs %}
{% if input.optional_flag_name %}
    _Bool {{ input.optional_flag_name }} = {{ "true" if input.optional_present else "false" }};
{% endif %}
    {{ input.c_type }} {{ input.name }}{{ input.array_suffix }};
{% endfor %}

    testbench_init_constant_input({% for input in constant_inputs %}{{ input.name }}{% if not loop.last %}, {% endif %}{% endfor %});
    if (input_path) {
        if (testbench_read_input_file(input_path{% for input in variable_inputs %}, {{ input.name }}{% endfor %}) != 0) {
            return 1;
        }
    } else {
        testbench_fill_random_input({% for input in variable_inputs %}{{ input.name }}{% if not loop.last %}, {% endif %}{% endfor %});
    }

{% for output in outputs %}
    {{ output.c_type }} {{ output.name }}{{ output.array_suffix }};
{% endfor %}

    if (!{{ model_name }}_load("{{ weight_data_filename }}")) {
        return 1;
    }

    timer_start();
    {{ model_name }}({% for dim in dim_args %}{{ dim.name }}, {% endfor %}{% for input in inputs %}{{ input.name }}{% if input.optional_flag_name %}, {{ input.optional_flag_name }}{% endif %}, {% endfor %}{% for output in outputs %}{{ output.name }}{% if not loop.last %}, {% endif %}{% endfor %});
    timer_stop();

    testbench_print_json({% for input in inputs %}{{ input.name }}, {% endfor %}{% for output in outputs %}{{ output.name }}{% if not loop.last %}, {% endif %}{% endfor %});
    return 0;
}

int main(int argc, char **argv) {
    const char *input_path = NULL;

    if (argc > 1) {
        input_path = argv[1];
    }

    return testbench_run(input_path);
}
