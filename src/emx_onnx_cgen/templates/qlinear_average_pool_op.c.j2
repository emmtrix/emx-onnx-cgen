EMX_NODE_FN void {{ op_name }}({{ dim_args }}{{ params | join(', ') }}) {
    const {{ compute_type }} scale = (({{ compute_type }}){{ input_scale_expr }}) / (({{ compute_type }}){{ output_scale_expr }});
    const int32_t input_zero = (int32_t){{ input_zero_expr }};
    const {{ compute_type }} output_zero = ({{ compute_type }}){{ output_zero_expr }};
{% if spatial_rank == 3 %}
    for (idx_t n = 0; n < {{ batch }}; ++n) {
        for (idx_t c = 0; c < {{ channels }}; ++c) {
            for (idx_t od = 0; od < {{ out_d }}; ++od) {
                for (idx_t oh = 0; oh < {{ out_h }}; ++oh) {
                    for (idx_t ow = 0; ow < {{ out_w }}; ++ow) {
                        int32_t acc = 0;
                        idx_t count = 0;
                        for (idx_t kd = 0; kd < {{ kernel_d }}; ++kd) {
                            const idx_t id = od * {{ stride_d }} + kd * {{ dilation_d }} - {{ pad_front }};
                            for (idx_t kh = 0; kh < {{ kernel_h }}; ++kh) {
                                const idx_t ih = oh * {{ stride_h }} + kh * {{ dilation_h }} - {{ pad_top }};
                                for (idx_t kw = 0; kw < {{ kernel_w }}; ++kw) {
                                    const idx_t iw = ow * {{ stride_w }} + kw * {{ dilation_w }} - {{ pad_left }};
                                    if (id >= 0 && id < {{ in_d }}
                                        && ih >= 0 && ih < {{ in_h }}
                                        && iw >= 0 && iw < {{ in_w }}) {
                                        acc += ((int32_t){{ input0 }}[n][c][id][ih][iw]) - input_zero;
                                        ++count;
                                    } else if ({{ 1 if count_include_pad else 0 }}) {
                                        ++count;
                                    }
                                }
                            }
                        }
                        const idx_t denom = {{ 1 if count_include_pad else 0 }} ? {{ kernel_d * kernel_h * kernel_w }} : count;
                        {{ compute_type }} mean = (denom > 0) ? ((({{ compute_type }})acc) / ({{ compute_type }})denom) : ({{ compute_type }})0;
                        {{ compute_type }} scaled = mean * scale + output_zero;
                        {{ compute_type }} rounded = {{ round_fn }}(scaled);
                        rounded = {{ max_fn }}(rounded, ({{ compute_type }}){{ min_literal }});
                        rounded = {{ min_fn }}(rounded, ({{ compute_type }}){{ max_literal }});
                        {{ output }}[n][c][od][oh][ow] = ({{ output_c_type }})rounded;
                    }
                }
            }
        }
    }
{% elif spatial_rank == 1 %}
    for (idx_t n = 0; n < {{ batch }}; ++n) {
        for (idx_t c = 0; c < {{ channels }}; ++c) {
            for (idx_t ow = 0; ow < {{ out_w }}; ++ow) {
                int32_t acc = 0;
                idx_t count = 0;
                for (idx_t kw = 0; kw < {{ kernel_w }}; ++kw) {
                    const idx_t iw = ow * {{ stride_w }} + kw * {{ dilation_w }} - {{ pad_left }};
                    if (iw >= 0 && iw < {{ in_w }}) {
                        acc += ((int32_t){{ input0 }}[n][c][iw]) - input_zero;
                        ++count;
                    } else if ({{ 1 if count_include_pad else 0 }}) {
                        ++count;
                    }
                }
                const idx_t denom = {{ 1 if count_include_pad else 0 }} ? {{ kernel_w }} : count;
                {{ compute_type }} mean = (denom > 0) ? ((({{ compute_type }})acc) / ({{ compute_type }})denom) : ({{ compute_type }})0;
                {{ compute_type }} scaled = mean * scale + output_zero;
                {{ compute_type }} rounded = {{ round_fn }}(scaled);
                rounded = {{ max_fn }}(rounded, ({{ compute_type }}){{ min_literal }});
                rounded = {{ min_fn }}(rounded, ({{ compute_type }}){{ max_literal }});
                {{ output }}[n][c][ow] = ({{ output_c_type }})rounded;
            }
        }
    }
{% else %}
    for (idx_t n = 0; n < {{ batch }}; ++n) {
        for (idx_t c = 0; c < {{ channels }}; ++c) {
            for (idx_t oh = 0; oh < {{ out_h }}; ++oh) {
                for (idx_t ow = 0; ow < {{ out_w }}; ++ow) {
                    int32_t acc = 0;
                    idx_t count = 0;
                    for (idx_t kh = 0; kh < {{ kernel_h }}; ++kh) {
                        const idx_t ih = oh * {{ stride_h }} + kh * {{ dilation_h }} - {{ pad_top }};
                        for (idx_t kw = 0; kw < {{ kernel_w }}; ++kw) {
                            const idx_t iw = ow * {{ stride_w }} + kw * {{ dilation_w }} - {{ pad_left }};
                            if (ih >= 0 && ih < {{ in_h }} && iw >= 0 && iw < {{ in_w }}) {
                                acc += ((int32_t){{ input0 }}[n][c][ih][iw]) - input_zero;
                                ++count;
                            } else if ({{ 1 if count_include_pad else 0 }}) {
                                ++count;
                            }
                        }
                    }
                    const idx_t denom = {{ 1 if count_include_pad else 0 }} ? {{ kernel_h * kernel_w }} : count;
                    {{ compute_type }} mean = (denom > 0) ? ((({{ compute_type }})acc) / ({{ compute_type }})denom) : ({{ compute_type }})0;
                    {{ compute_type }} scaled = mean * scale + output_zero;
                    {{ compute_type }} rounded = {{ round_fn }}(scaled);
                    rounded = {{ max_fn }}(rounded, ({{ compute_type }}){{ min_literal }});
                    rounded = {{ min_fn }}(rounded, ({{ compute_type }}){{ max_literal }});
                    {{ output }}[n][c][oh][ow] = ({{ output_c_type }})rounded;
                }
            }
        }
    }
{% endif %}
}
